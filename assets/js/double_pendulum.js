document.addEventListener("DOMContentLoaded",function(){function e(e,t,n){const a=e(t),o=e(t.map((e,t)=>e+a[t]*n/2)),i=e(t.map((e,t)=>e+o[t]*n/2)),l=e(t.map((e,t)=>e+i[t]*n));return t.map((e,t)=>e+n/6*(a[t]+2*o[t]+2*i[t]+l[t]))}function t(e){const[t,n,a,o]=e;return[a+-A*a,o+-A*o,(-B*(2*w+M)*Math.sin(t)-M*B*Math.sin(t-2*n)-2*Math.sin(t-n)*M*(o*o*P+a*a*I*Math.cos(t-n)))/(I*(2*w+M-M*Math.cos(2*t-2*n))),2*Math.sin(t-n)*(a*a*I*(w+M)+B*(w+M)*Math.cos(t)+o*o*P*M*Math.cos(t-n))/(P*(2*w+M-M*Math.cos(2*t-2*n)))]}function n(e){const t=parseFloat(document.getElementById("fade-duration").value),n=Math.ceil(t/F),[a,o]=e,i=I*Math.sin(a),l=-I*Math.cos(a),r=i+P*Math.sin(o),s=l-P*Math.cos(o);g[0].x=[i],g[0].y=[l],g[1].x=[r],g[1].y=[s],h.x=[0,i,r],h.y=[0,l,s],y.x=[i,...y.x.slice(0,n-1)],y.y=[l,...y.y.slice(0,n-1)],x.x=[r,...x.x.slice(0,n-1)],x.y=[s,...x.y.slice(0,n-1)]}function a(){S&&(n(_),Plotly.update("double-pendulum-plot",{x:g.map(e=>e.x),y:g.map(e=>e.y)}))}function o(){const e=b[0].x.length*F,t=Math.max(0,e-2);b[0].x.push(e),b[0].y.push(_[0]),b[1].x.push(e),b[1].y.push(_[1]),v[0].x.push(e),v[0].y.push(q[0]),v[1].x.push(e),v[1].y.push(q[1]);const n={xaxis:{title:"Time (s)",range:[t,e]},yaxis:{title:"State"}},a={xaxis:{title:"Time (s)",range:[t,e]},yaxis:{title:"Derivative"}};Plotly.update("state-plot",{x:b.map(e=>e.x),y:b.map(e=>e.y)},n),Plotly.update("deriv-plot",{x:v.map(e=>e.x),y:v.map(e=>e.y)},a)}function i(){_=e(t,_,F),E+=F}function l(e){if(!S)return;e-H>T/C&&(i(),q=t(_),O++,a(),O>=D&&(o(),O=0),H=e),requestAnimationFrame(l)}function r(){S||(S=!0,requestAnimationFrame(l))}function s(){S=!1,clearInterval(a)}function d(e){S=!1,"m1"===e.target.id?w=parseFloat(e.target.value):"m2"===e.target.id?M=parseFloat(e.target.value):"gravity"===e.target.id?B=parseFloat(e.target.value):"time-step"===e.target.id?F=parseFloat(e.target.value):"steps"===e.target.id?z=parseInt(e.target.value):"damping"===e.target.id&&(A=parseFloat(e.target.value)),r()}const c=document.getElementById("double-pendulum-container"),m=c.offsetWidth,u=c.offsetHeight,g=[{x:[0],y:[0],mode:"markers",marker:{color:"rgba(255, 165, 0, 0.8)",size:14}},{x:[0],y:[0],mode:"markers",marker:{color:"rgba(128, 0, 128, 0.8)",size:14}}],p={xaxis:{range:[-2,2],zeroline:!1,showgrid:!1,showticklabels:!1,fixedrange:!0,linecolor:"rgba(128, 128, 128, 0.5)",linewidth:1},yaxis:{range:[-2,2],scaleanchor:"x",zeroline:!1,showgrid:!1,showticklabels:!1,fixedrange:!0,linecolor:"rgba(128, 128, 128, 0.5)",linewidth:1},plot_bgcolor:"rgba(40, 40, 40, 0.5)",paper_bgcolor:"rgba(40, 40, 40, 1)",width:m,height:u,showlegend:!1,margin:{t:0,r:0,l:0,b:0},font:{color:"white"}},h={x:[0,0,0],y:[0,0,0],mode:"lines",line:{color:"white",width:2}},y={x:[],y:[],mode:"lines",line:{color:"rgba(255, 165, 0, 0.5)",width:1}},x={x:[],y:[],mode:"lines",line:{color:"rgba(128, 0, 128, 0.5)",width:1}};g.push(h),g.push(y,x);const b=[{x:[],y:[],mode:"lines",name:"theta1",line:{color:"rgba(255, 165, 0, 0.8)"}},{x:[],y:[],mode:"lines",name:"theta2",line:{color:"rgba(128, 0, 128, 0.8)"}}],v=[{x:[],y:[],mode:"lines",name:"dtheta1",line:{color:"orange"}},{x:[],y:[],mode:"lines",name:"dtheta2",line:{color:"green"}}],f={width:600,height:300,plot_bgcolor:"rgba(40, 40, 40, 0.5)",paper_bgcolor:"rgba(40, 40, 40, 1)",font:{color:"white"}};Plotly.newPlot("double-pendulum-plot",g,p,{staticPlot:!0}),Plotly.newPlot("state-plot",b,f),Plotly.newPlot("deriv-plot",v,f);let E=0,w=1,M=1,I=1,P=1,B=9.81,L=Math.PI/2,k=Math.PI,F=.01,z=1e3,_=[L,k,0,0],q=[0,0,0,0],A=0,D=2,T=1e3,C=60,H=0;let O=0,S=!1;document.getElementById("start-button").addEventListener("click",r),document.getElementById("stop-button").addEventListener("click",s),document.getElementById("m1").addEventListener("input",d),document.getElementById("m2").addEventListener("input",d),document.getElementById("gravity").addEventListener("input",d),document.getElementById("steps").addEventListener("input",d),document.getElementById("damping").addEventListener("input",d),document.getElementById("time-step").addEventListener("input",d)});